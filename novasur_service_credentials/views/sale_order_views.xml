<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- Herencia del formulario de sale.order -->
    <record id="view_order_form_inherit_credentials" model="ir.ui.view">
      <field name="name">sale.order.form.inherit.credentials</field>
      <field name="model">sale.order</field>
      <field name="inherit_id" ref="sale.view_order_form"/>
      <field name="arch" type="xml">

        <!-- 1) Campo t√©cnico oculto para mostrar aviso (aseg√∫rate de tenerlo en el modelo) -->
        <xpath expr="//group[@name='partner_details']/field[@name='partner_id']" position="after">
          <field name="has_digital_services" invisible="1"/>
        </xpath>

        <!-- 2) Aviso arriba del sheet cuando hay servicios digitales -->
        <xpath expr="//sheet" position="before">
          <div class="alert alert-info" role="alert"
               invisible="not has_digital_services or state != 'draft'"
               style="margin-bottom:0;">
            <strong>‚ÑπÔ∏è Servicios Digitales:</strong>
            Esta orden contiene servicios digitales. Las credenciales se asignar√°n autom√°ticamente al confirmar la venta.
          </div>
        </xpath>

        <!-- 3) A√±adir columnas en el LIST embebido de order_line, despu√©s de product_uom_qty -->
        <xpath expr="//field[@name='order_line']/list//field[@name='product_uom_qty']" position="after">
          <field name="service_credential_id"
                 optional="show"
                 readonly="1"
                 string="Credencial"
                 groups="sales_team.group_sale_manager"/>
          <field name="credential_state"
                 optional="hide"
                 widget="badge"
                 string="Estado"
                 decoration-success="credential_state == 'available'"
                 decoration-info="credential_state == 'assigned'"
                 decoration-danger="credential_state == 'expired'"
                 decoration-warning="credential_state == 'pending_reset'"
                 groups="sales_team.group_sale_manager"/>
        </xpath>

        <!-- 4) Decoraci√≥n visual de filas sin credencial para productos digitales -->
        <xpath expr="//field[@name='order_line']/list" position="attributes">
          <attribute name="decoration-warning">product_id.is_digital_service and not service_credential_id</attribute>
        </xpath>

        <!-- 5) Bloque de datos de credencial en el FORM embebido de la l√≠nea -->
        <xpath expr="//field[@name='order_line']/form//div[@name='invoice_lines']" position="after">
          <group string="üîë Credencial Digital"
                 name="credential_group"
                 invisible="not service_credential_id"
                 groups="sales_team.group_sale_manager">
            <field name="service_credential_id" invisible="1"/>
            <field name="credential_login" readonly="1" string="Usuario/Email"/>
            <field name="credential_password" password="True" readonly="1" string="Contrase√±a" groups="base.group_system"/>
            <field name="credential_state" readonly="1" widget="badge"
                   decoration-success="credential_state == 'available'"
                   decoration-info="credential_state == 'assigned'"
                   decoration-danger="credential_state == 'expired'"
                   decoration-warning="credential_state == 'pending_reset'"/>
            <button name="action_view_credential"
                    string="Ver Credencial Completa"
                    type="object"
                    class="btn-link"
                    icon="fa-external-link"
                    help="Abre el formulario completo de la credencial"/>
          </group>

          <group string="‚öôÔ∏è Acciones Manuales"
                 name="credential_actions"
                 invisible="service_credential_id or not product_id.is_digital_service"
                 groups="sales_team.group_sale_manager">
            <button name="action_assign_credential_manually"
                    string="Asignar Credencial Manualmente"
                    type="object"
                    class="btn-primary"
                    icon="fa-plus-circle"
                    help="Asigna manualmente una credencial disponible"/>
          </group>
        </xpath>

      </field>
    </record>

  </data>
</odoo>
